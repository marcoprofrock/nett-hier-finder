<html lang="de"><head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sticker Moderation - Nett hier.</title>
    
    <!-- Supabase JS -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #f5f5f5;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
        }

        .header {
            background: #2A2623;
            color: #FFFC00;
            padding: 24px;
            border-radius: 12px;
            margin-bottom: 24px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .header p {
            opacity: 0.9;
            font-size: 14px;
        }

        .stats {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 16px;
        }

        .stat {
            background: rgba(255, 252, 0, 0.1);
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
        }

        .stat strong {
            font-size: 20px;
            display: block;
        }

        .card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .image-container {
            position: relative;
            width: 100%;
            height: 500px;
            background: linear-gradient(135deg, #FFFC00 0%, #FFD700 100%);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .image-container img {
            width: 100%;
            height: 100%;
            object-fit: contain;
            display: none;
        }

        .image-container img.loaded {
            display: block;
        }

        .image-loading {
            font-size: 64px;
            animation: pulse 1.5s ease-in-out infinite;
        }

        .image-error {
            font-size: 64px;
            display: none;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.6; transform: scale(0.95); }
        }

        .info {
            padding: 24px;
        }

        .meta-row {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .meta-field {
            flex: 1;
        }

        .meta-field label {
            display: block;
            font-size: 12px;
            color: #666;
            margin-bottom: 4px;
            font-weight: 600;
        }

        .meta-field input {
            width: 100%;
            padding: 10px;
            border: 2px solid #E4E0E0;
            border-radius: 8px;
            font-size: 14px;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .meta-field input:focus {
            outline: none;
            border-color: #FFFC00;
        }

        .meta-field.readonly input {
            background: #f9f9f9;
            color: #999;
        }

        .source-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #E8F5E9;
            color: #2E7D32;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .source-badge.instagram {
            background: #FCE4EC;
            color: #C2185B;
        }

        .source-badge.reddit {
            background: #FFF3E0;
            color: #E65100;
        }

        .original-link {
            display: inline-block;
            margin-top: 8px;
            font-size: 13px;
            color: #2A2623;
            text-decoration: none;
            font-weight: 600;
        }

        .original-link:hover {
            text-decoration: underline;
        }

        .actions {
            display: flex;
            gap: 12px;
            padding: 0 24px 24px;
        }

        .btn {
            flex: 1;
            padding: 16px;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-approve {
            background: #4CAF50;
            color: white;
        }

        .btn-approve:hover {
            background: #45a049;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(76, 175, 80, 0.4);
        }

        .btn-reject {
            background: #f44336;
            color: white;
        }

        .btn-reject:hover {
            background: #da190b;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(244, 67, 54, 0.4);
        }

        .btn-skip {
            background: #fff;
            border: 2px solid #ddd;
            color: #666;
        }

        .btn-skip:hover {
            background: #f9f9f9;
            border-color: #999;
        }

        .progress {
            background: #E4E0E0;
            height: 8px;
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 24px;
        }

        .progress-bar {
            background: linear-gradient(90deg, #FFFC00 0%, #FFD700 100%);
            height: 100%;
            transition: width 0.3s;
        }

        .keyboard-hints {
            text-align: center;
            padding: 16px;
            background: #f9f9f9;
            border-radius: 8px;
            margin-bottom: 24px;
            font-size: 13px;
            color: #666;
        }

        .keyboard-hints kbd {
            display: inline-block;
            padding: 3px 8px;
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            box-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }

        .no-posts {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .no-posts h2 {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .alert {
            position: fixed;
            top: 20px;
            right: 20px;
            background: white;
            padding: 16px 24px;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            display: none;
            z-index: 9999;
            font-weight: 600;
        }

        .alert.show {
            display: block;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .alert.success {
            border-left: 4px solid #4CAF50;
            color: #2E7D32;
        }

        .alert.error {
            border-left: 4px solid #f44336;
            color: #C62828;
        }

        .save-indicator {
            display: none;
            color: #4CAF50;
            font-size: 13px;
            margin-top: 8px;
            font-weight: 600;
        }

        .save-indicator.show {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üîç Sticker-Moderation</h1>
            <p>Pr√ºfe, bearbeite und gebe Sticker-Funde frei</p>
            <div class="stats">
                <div class="stat">
                    <strong id="pending-count">-</strong>
                    Zu pr√ºfen
                </div>
                <div class="stat">
                    <strong id="approved-count">-</strong>
                    Freigegeben
                </div>
                <div class="stat">
                    <strong id="rejected-count">-</strong>
                    Abgelehnt
                </div>
            </div>
        </div>

        <!-- Progress Bar -->
        <div class="progress">
            <div class="progress-bar" id="progress-bar" style="width: 0%"></div>
        </div>

        <!-- Keyboard Hints -->
        <div class="keyboard-hints">
            <kbd>‚Üê</kbd> Ablehnen ‚Ä¢ 
            <kbd>‚Üí</kbd> oder <kbd>A</kbd> Freigeben ‚Ä¢ 
            <kbd>S</kbd> Speichern &amp; N√§chster ‚Ä¢ 
            <kbd>‚Üì</kbd> √úberspringen
        </div>

        <!-- Current Post Card -->
        <div id="post-card" class="card" style="display: none;">
            <div class="image-container">
                <div class="image-loading">‚è≥</div>
                <div class="image-error">‚ùå</div>
                <img id="current-image" alt="Sticker">
            </div>

            <div class="info">
                <div class="meta-row">
                    <div class="meta-field">
                        <label for="edit-city">Stadt *</label>
                        <input type="text" id="edit-city" placeholder="z.B. Berlin">
                        <div class="save-indicator" id="city-saved">‚úì Gespeichert</div>
                    </div>
                    <div class="meta-field">
                        <label for="edit-country">Land *</label>
                        <input type="text" id="edit-country" placeholder="z.B. Germany">
                        <div class="save-indicator" id="country-saved">‚úì Gespeichert</div>
                    </div>
                </div>

                <div class="meta-row">
                    <div class="meta-field readonly">
                        <label>GPS</label>
                        <input type="text" id="gps-coords" readonly="">
                    </div>
                    <div class="meta-field readonly">
                        <label>Quelle</label>
                        <input type="text" id="source-display" readonly="">
                    </div>
                </div>

                <div id="original-link-container"></div>
            </div>

            <div class="actions">
                <button class="btn btn-reject" id="btn-reject" title="Pfeiltaste links">
                    ‚Üê Ablehnen
                </button>
                <button class="btn btn-skip" id="btn-skip" title="Pfeiltaste unten">
                    ‚Üì √úberspringen
                </button>
                <button class="btn btn-approve" id="btn-approve" title="Pfeiltaste rechts">
                    Freigeben ‚Üí
                </button>
            </div>
        </div>

        <!-- No Posts Message -->
        <div id="no-posts" class="no-posts" style="display: none;">
            <h2>üéâ</h2>
            <h3>Alle Posts gepr√ºft!</h3>
            <p>Keine weiteren Sticker zur Moderation.</p>
        </div>
    </div>

    <!-- Alert -->
    <div id="alert" class="alert"></div>

    <script>
        // ========================================
        // CONFIG
        // ========================================
        const SUPABASE_URL = 'https://fmnshdjqmsladddxcheb.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZtbnNoZGpxbXNsYWRkZHhjaGViIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk2MDg5MTUsImV4cCI6MjA4NTE4NDkxNX0.UwXYfDd2C300UtvI8Rc2t0S6uCaeFpgecRgGogOdW4c';

        const { createClient } = supabase;
        const supabaseClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // ========================================
        // STATE
        // ========================================
        let pendingPosts = [];
        let currentIndex = 0;
        let currentPost = null;
        let stats = {
            pending: 0,
            approved: 0,
            rejected: 0
        };

        // ========================================
        // INIT
        // ========================================
        document.addEventListener('DOMContentLoaded', async () => {
            await loadStats();
            await loadPendingPosts();
            setupKeyboardShortcuts();
            setupEditHandlers();
        });

        // ========================================
        // LOAD DATA
        // ========================================
        async function loadStats() {
            try {
                const [pending, approved, rejected] = await Promise.all([
                    supabaseClient.from('sticker_findings').select('*', { count: 'exact', head: true }).eq('status', 'pending'),
                    supabaseClient.from('sticker_findings').select('*', { count: 'exact', head: true }).eq('status', 'approved'),
                    supabaseClient.from('sticker_findings').select('*', { count: 'exact', head: true }).eq('status', 'rejected')
                ]);

                stats = {
                    pending: pending.count || 0,
                    approved: approved.count || 0,
                    rejected: rejected.count || 0
                };

                updateStatsDisplay();
            } catch (error) {
                console.error('Stats load error:', error);
            }
        }

        async function loadPendingPosts() {
            try {
                let allPosts = [];
                let from = 0;
                const batchSize = 1000;
                let hasMore = true;

                while (hasMore) {
                    const { data, error } = await supabaseClient
                        .from('sticker_findings')
                        .select('*')
                        .eq('status', 'pending')
                        .order('created_at', { ascending: false })
                        .range(from, from + batchSize - 1);

                    if (error) {
                        console.error('Load error:', error);
                        break;
                    }

                    if (data && data.length > 0) {
                        allPosts = allPosts.concat(data);
                        from += batchSize;
                        
                        if (data.length < batchSize) {
                            hasMore = false;
                        }
                    } else {
                        hasMore = false;
                    }
                }

                pendingPosts = allPosts;
                console.log(`üìã ${pendingPosts.length} Posts zu pr√ºfen`);

                if (pendingPosts.length > 0) {
                    showPost(0);
                } else {
                    showNoPostsMessage();
                }

            } catch (error) {
                console.error('Fehler beim Laden:', error);
                showAlert('Fehler beim Laden der Posts', 'error');
            }
        }

        // ========================================
        // DISPLAY POST
        // ========================================
        function showPost(index) {
            if (index >= pendingPosts.length) {
                showNoPostsMessage();
                return;
            }

            currentIndex = index;
            currentPost = pendingPosts[index];

            document.getElementById('post-card').style.display = 'block';
            document.getElementById('no-posts').style.display = 'none';

            // Bild laden
            const img = document.getElementById('current-image');
            const loading = document.querySelector('.image-loading');
            const errorIcon = document.querySelector('.image-error');

            // Reset
            img.classList.remove('loaded');
            img.style.display = 'none';
            loading.style.display = 'flex';
            errorIcon.style.display = 'none';

            // Clean URL
            let cleanUrl = currentPost.image_url ? currentPost.image_url.replace(/&amp;/g, '&') : '';

            // Verschiedene Lade-Strategien je nach Quelle
            let imageUrl = cleanUrl;
            
            if (currentPost.source === 'Instagram') {
                // F√ºr Instagram: Versuche Proxies
                imageUrl = `https://images.weserv.nl/?url=${encodeURIComponent(cleanUrl)}&w=400&h=400&fit=cover`;
            }

            img.onload = () => {
                img.classList.add('loaded');
                img.style.display = 'block';
                loading.style.display = 'none';
                console.log('‚úÖ Bild geladen');
            };

            img.onerror = () => {
                // Zweiter Versuch mit allorigins
                if (currentPost.source === 'Instagram' && !img.src.includes('allorigins')) {
                    console.log('‚ö†Ô∏è Erster Proxy failed, versuche allorigins...');
                    img.src = `https://api.allorigins.win/raw?url=${encodeURIComponent(cleanUrl)}`;
                } else {
                    // Komplett fehlgeschlagen
                    loading.style.display = 'none';
                    errorIcon.style.display = 'flex';
                    errorIcon.innerHTML = '‚ùå<br><span style="font-size: 16px;">Bild nicht ladbar</span>';
                    console.log('‚ùå Bild konnte nicht geladen werden');
                }
            };

            img.src = imageUrl;

            // Felder bef√ºllen
            document.getElementById('edit-city').value = currentPost.city || '';
            document.getElementById('edit-country').value = currentPost.country || '';
            document.getElementById('gps-coords').value = `${currentPost.latitude?.toFixed(4)}, ${currentPost.longitude?.toFixed(4)}`;
            document.getElementById('source-display').value = currentPost.source || 'Web';

            // Source Badge + Link
            const linkContainer = document.getElementById('original-link-container');
            if (currentPost.source && currentPost.source !== 'Web' && currentPost.post_url) {
                linkContainer.innerHTML = `
                    <div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid #E4E0E0;">
                        <span class="source-badge ${currentPost.source.toLowerCase()}">${currentPost.source}</span>
                        <a href="${currentPost.post_url}" target="_blank" class="original-link">
                            üì∑ Original ansehen ‚Üí
                        </a>
                    </div>
                `;
            } else {
                linkContainer.innerHTML = '';
            }

            // Progress
            updateProgress();

            // Reset save indicators
            document.querySelectorAll('.save-indicator').forEach(el => el.classList.remove('show'));
        }

        // ========================================
        // ACTIONS
        // ========================================
        async function approvePost() {
            if (!currentPost) return;

            // Speichere erst die bearbeiteten Daten
            await saveEdits();

            try {
                const { error } = await supabaseClient
                    .from('sticker_findings')
                    .update({ status: 'approved' })
                    .eq('id', currentPost.id);

                if (error) throw error;

                stats.pending--;
                stats.approved++;
                updateStatsDisplay();
                showAlert('‚úÖ Freigegeben!', 'success');
                
                // N√§chster Post
                showPost(currentIndex + 1);

            } catch (error) {
                console.error('Approve error:', error);
                showAlert('Fehler beim Freigeben', 'error');
            }
        }

        async function rejectPost() {
            if (!currentPost) return;

            try {
                const { error } = await supabaseClient
                    .from('sticker_findings')
                    .update({ status: 'rejected' })
                    .eq('id', currentPost.id);

                if (error) throw error;

                stats.pending--;
                stats.rejected++;
                updateStatsDisplay();
                showAlert('‚ùå Abgelehnt', 'error');
                
                // N√§chster Post
                showPost(currentIndex + 1);

            } catch (error) {
                console.error('Reject error:', error);
                showAlert('Fehler beim Ablehnen', 'error');
            }
        }

        async function skipPost() {
            // Speichere Edits (falls vorhanden)
            await saveEdits();
            
            // N√§chster
            showPost(currentIndex + 1);
        }

        async function saveEdits() {
            if (!currentPost) return;

            const newCity = document.getElementById('edit-city').value.trim();
            const newCountry = document.getElementById('edit-country').value.trim();

            // Nur updaten wenn ge√§ndert
            if (newCity !== currentPost.city || newCountry !== currentPost.country) {
                try {
                    const { error } = await supabaseClient
                        .from('sticker_findings')
                        .update({ 
                            city: newCity || null, 
                            country: newCountry || null 
                        })
                        .eq('id', currentPost.id);

                    if (error) throw error;

                    console.log('üíæ Stadt/Land aktualisiert');
                    
                    // Update currentPost
                    currentPost.city = newCity;
                    currentPost.country = newCountry;

                } catch (error) {
                    console.error('Update error:', error);
                    showAlert('Fehler beim Speichern', 'error');
                }
            }
        }

        // ========================================
        // EDIT HANDLERS
        // ========================================
        function setupEditHandlers() {
            const cityInput = document.getElementById('edit-city');
            const countryInput = document.getElementById('edit-country');

            // Auto-Save nach 1 Sekunde Inaktivit√§t
            let saveTimeout;

            function handleInput(inputElement, indicatorId) {
                clearTimeout(saveTimeout);
                
                saveTimeout = setTimeout(async () => {
                    await saveEdits();
                    
                    // Zeige "Gespeichert" Indicator
                    const indicator = document.getElementById(indicatorId);
                    indicator.classList.add('show');
                    setTimeout(() => {
                        indicator.classList.remove('show');
                    }, 2000);
                }, 1000);
            }

            cityInput.addEventListener('input', () => handleInput(cityInput, 'city-saved'));
            countryInput.addEventListener('input', () => handleInput(countryInput, 'country-saved'));
        }

        // ========================================
        // KEYBOARD SHORTCUTS
        // ========================================
        function setupKeyboardShortcuts() {
            document.addEventListener('keydown', async (e) => {
                // Nur wenn kein Input fokussiert ist
                if (document.activeElement.tagName === 'INPUT') {
                    // Aber Enter im Input = Speichern + N√§chster
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        document.activeElement.blur();
                        await saveEdits();
                        showAlert('üíæ Gespeichert!', 'success');
                    }
                    return;
                }

                switch(e.key) {
                    case 'ArrowRight':
                    case 'a':
                    case 'A':
                        e.preventDefault();
                        await approvePost();
                        break;
                    
                    case 'ArrowLeft':
                    case 'r':
                    case 'R':
                        e.preventDefault();
                        await rejectPost();
                        break;
                    
                    case 'ArrowDown':
                    case 's':
                    case 'S':
                        e.preventDefault();
                        await skipPost();
                        break;
                }
            });
        }

        // ========================================
        // UI UPDATES
        // ========================================
        function updateStatsDisplay() {
            document.getElementById('pending-count').textContent = stats.pending;
            document.getElementById('approved-count').textContent = stats.approved;
            document.getElementById('rejected-count').textContent = stats.rejected;
        }

        function updateProgress() {
            const total = pendingPosts.length;
            const done = currentIndex;
            const percent = (done / total) * 100;

            document.getElementById('progress-bar').style.width = percent + '%';
        }

        function showNoPostsMessage() {
            document.getElementById('post-card').style.display = 'none';
            document.getElementById('no-posts').style.display = 'block';
        }

        function showAlert(message, type) {
            const alert = document.getElementById('alert');
            alert.textContent = message;
            alert.className = `alert ${type} show`;

            setTimeout(() => {
                alert.classList.remove('show');
            }, 3000);
        }

        // ========================================
        // BUTTON HANDLERS
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('btn-approve')?.addEventListener('click', approvePost);
            document.getElementById('btn-reject')?.addEventListener('click', rejectPost);
            document.getElementById('btn-skip')?.addEventListener('click', skipPost);
        });
    </script>

</body></html>